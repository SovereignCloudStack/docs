"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[96211],{31412:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"operating-scs/components/monitoring/docs/iaas","title":"IaaS monitoring (experimental)","description":"This component is marked as experimental, and it is not part of the reference SCS installation available","source":"@site/docs/04-operating-scs/components/monitoring/docs/iaas.md","sourceDirName":"04-operating-scs/components/monitoring/docs","slug":"/operating-scs/components/monitoring/docs/iaas","permalink":"/docs/operating-scs/components/monitoring/docs/iaas","draft":false,"unlisted":false,"editUrl":"https://github.com/SovereignCloudStack/docs/tree/main/docs/04-operating-scs/components/monitoring/docs/iaas.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Infrastructure service endpoints","permalink":"/docs/operating-scs/components/monitoring/docs/infrastructure_services"},"next":{"title":"KaaS monitoring (experimental)","permalink":"/docs/operating-scs/components/monitoring/docs/kaas"}}');var o=n(74848),r=n(28453);const a={},i="IaaS monitoring (experimental)",l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Local environment use case - KinD/K3s cluster deployed locally",id:"local-environment-use-case---kindk3s-cluster-deployed-locally",level:3},{value:"KinD",id:"kind",level:4},{value:"K3s",id:"k3s",level:4},{value:"OSISM use case - K3s cluster in OSISM deployment",id:"osism-use-case---k3s-cluster-in-osism-deployment",level:3},{value:"Deploy IaaS monitoring components",id:"deploy-iaas-monitoring-components",level:2},{value:"OpenStack",id:"openstack",level:3},{value:"Prometheus metrics and alerts",id:"prometheus-metrics-and-alerts",level:4},{value:"Grafana dashboards",id:"grafana-dashboards",level:4},{value:"Update the SCS monitoring deployment",id:"update-the-scs-monitoring-deployment",level:4},{value:"Access the OpenStack dashboard",id:"access-the-openstack-dashboard",level:4},{value:"Ceph",id:"ceph",level:3},{value:"Prometheus metrics and alerts",id:"prometheus-metrics-and-alerts-1",level:4},{value:"Grafana dashboards",id:"grafana-dashboards-1",level:4},{value:"Update the SCS monitoring deployment",id:"update-the-scs-monitoring-deployment-1",level:4}];function h(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s.header,{children:(0,o.jsx)(s.h1,{id:"iaas-monitoring-experimental",children:"IaaS monitoring (experimental)"})}),"\n",(0,o.jsxs)(s.p,{children:["This component is marked as experimental, and it is not part of the reference SCS installation available\nat ",(0,o.jsx)(s.a,{href:"https://monitoring.scs.community",children:"https://monitoring.scs.community"}),"."]}),"\n",(0,o.jsx)(s.p,{children:"IaaS monitoring currently integrates and is able to observe the following targets:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"#openstack",children:"OpenStack"})}),"\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"#ceph",children:"Ceph"})}),"\n"]}),"\n",(0,o.jsx)(s.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsx)(s.p,{children:"To test the Monitoring of the IaaS layer we expect running Kubernetes cluster that already contains\nSCS monitoring platform."}),"\n",(0,o.jsx)(s.h3,{id:"local-environment-use-case---kindk3s-cluster-deployed-locally",children:"Local environment use case - KinD/K3s cluster deployed locally"}),"\n",(0,o.jsx)(s.h4,{id:"kind",children:"KinD"}),"\n",(0,o.jsxs)(s.p,{children:["Install the SCS monitoring solution into the KinD Kubernetes cluster following the instructions provided in\nthe ",(0,o.jsx)(s.a,{href:"/docs/operating-scs/components/monitoring/docs/quickstart",children:"quickstart guide"}),"."]}),"\n",(0,o.jsx)(s.h4,{id:"k3s",children:"K3s"}),"\n",(0,o.jsxs)(s.p,{children:["Install the SCS monitoring solution into the K3s Kubernetes cluster following the instructions provided in\nthe ",(0,o.jsx)(s.a,{href:"/docs/operating-scs/components/monitoring/docs/k3s",children:"k3s guide"}),"."]}),"\n",(0,o.jsx)(s.h3,{id:"osism-use-case---k3s-cluster-in-osism-deployment",children:"OSISM use case - K3s cluster in OSISM deployment"}),"\n",(0,o.jsxs)(s.p,{children:[(0,o.jsx)(s.a,{href:"https://osism.tech/docs/guides/deploy-guide/services/kubernetes",children:"OSISM"})," utilizes the k3s distribution of Kubernetes\nas a management cluster for the OSISM IaaS platform. This management cluster is then used as a host for\nthe SCS monitoring solution. Subsequently, the management cluster becomes an Observer cluster as it hosts\nthe SCS monitoring solution.\nFrom that point, the Observer cluster observes itself (i.e., k3s cluster control plane components and nodes) and is used\nfor observing the IaaS layer around the k3s cluster."]}),"\n",(0,o.jsxs)(s.p,{children:["In the case of the existing ",(0,o.jsx)(s.a,{href:"https://osism.tech/docs/release-notes/osism-7#703",children:"OSISM IaaS deployment >= 7.0.3"})," on\nbaremetal, ",(0,o.jsx)(s.a,{href:"https://osism.tech/docs/guides/other-guides/testbed",children:"testbed"})," or ",(0,o.jsx)(s.a,{href:"https://osism.tech/docs/guides/other-guides/cloud-in-a-box",children:"cloud in the box"}),"\nwe expect a management k3s Kubernetes cluster with the deployed SCS monitoring platform.\nIf your OSISM installation does not meet the above requirements, apply the following plays:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"osism apply kubernetes\nosism apply kubernetes-monitoring\n"})}),"\n",(0,o.jsx)(s.h2,{id:"deploy-iaas-monitoring-components",children:"Deploy IaaS monitoring components"}),"\n",(0,o.jsx)(s.h3,{id:"openstack",children:"OpenStack"}),"\n",(0,o.jsx)(s.h4,{id:"prometheus-metrics-and-alerts",children:"Prometheus metrics and alerts"}),"\n",(0,o.jsxs)(s.p,{children:["The ",(0,o.jsx)(s.a,{href:"https://github.com/openstack-exporter",children:"OpenStack exporter for Prometheus"})," could be deployed using the SCS ",(0,o.jsx)(s.a,{href:"https://github.com/SovereignCloudStack/openstack-exporter-helm-charts",children:"openstack-exporter-helm-chart"}),".\nThis exporter contains a bunch of ",(0,o.jsx)(s.a,{href:"https://github.com/SovereignCloudStack/openstack-exporter-helm-charts/blob/master/charts/prometheus-openstack-exporter/templates/prometheusrule.yaml",children:"Prometheus alerts and rules"}),"\nthat are deployed together with the exporter.\nVisit the ",(0,o.jsx)(s.code,{children:"iaas/openstack-exporter-values.yaml"})," file to validate the Helm configuration options.\nEnsure valid OpenStack API credentials are set under the ",(0,o.jsx)(s.code,{children:"clouds_yaml_config"})," section. This ",(0,o.jsx)(s.strong,{children:"MUST"})," be overridden!"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:'helm upgrade --install prometheus-openstack-exporter oci://registry.scs.community/openstack-exporter/prometheus-openstack-exporter \\\n  --version 0.4.5 \\\n  -f iaas/openstack-exporter-values.yaml # --set "endpoint_type=public" --set "serviceMonitor.scrapeTimeout=1m"\n'})}),"\n",(0,o.jsxs)(s.p,{children:["Tip: If you want to test the exporter basic functionality with ",(0,o.jsx)(s.strong,{children:"public"})," OpenStack API, configure ",(0,o.jsx)(s.code,{children:"endpoint_type"}),"\nto ",(0,o.jsx)(s.code,{children:"public"})," (",(0,o.jsx)(s.code,{children:'--set "endpoint_type=public"'}),"). Note that configuring ",(0,o.jsx)(s.code,{children:"endpoint_type"})," as ",(0,o.jsx)(s.code,{children:"public"})," will result in\nincomplete functionality for the Grafana dashboard."]}),"\n",(0,o.jsxs)(s.p,{children:["Tip: Requesting and collecting metrics from the OpenStack API can be time-consuming, especially if the API is not\nperforming well. In such cases, you may observe timeouts on the Prometheus server when it tries to fetch OpenStack\nmetrics. To mitigate this, consider increasing the scrape interval to e.g. 1 minute (",(0,o.jsx)(s.code,{children:'--set "serviceMonitor.scrapeTimeout=1m"'}),")."]}),"\n",(0,o.jsx)(s.h4,{id:"grafana-dashboards",children:"Grafana dashboards"}),"\n",(0,o.jsxs)(s.p,{children:["The Grafana dashboard designed to visualize metrics collected from an OpenStack cloud through the OpenStack exporter\nis publicly available at ",(0,o.jsx)(s.a,{href:"https://grafana.com/grafana/dashboards/21085",children:"https://grafana.com/grafana/dashboards/21085"}),". Its source code is located in the\n",(0,o.jsx)(s.code,{children:"iaas/dashboards"})," directory. Feel free to import it to the Grafana via its source or ID.\nFor automatic integration into the SCS monitoring solution proceed to the next step."]}),"\n",(0,o.jsx)(s.h4,{id:"update-the-scs-monitoring-deployment",children:"Update the SCS monitoring deployment"}),"\n",(0,o.jsx)(s.p,{children:"This step deploys the Grafana dashboards and instructs the monitoring stack to add the OpenStack exporter target into the Prometheus configuration:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"helm upgrade dnation-kubernetes-monitoring-stack dnationcloud/dnation-kubernetes-monitoring-stack --reset-then-reuse-values -f iaas/values-observer-iaas.yaml\n"})}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Note: The ",(0,o.jsx)(s.code,{children:"--reset-then-reuse-values"})," option requires Helm v3.14.0 or later. Alternatively, you can use the original values\nby applying ",(0,o.jsx)(s.code,{children:"-f values-observer.yaml"}),", see full command: ",(0,o.jsx)(s.code,{children:"helm upgrade dnation-kubernetes-monitoring-stack dnationcloud/dnation-kubernetes-monitoring-stack -f values-observer.yaml -f iaas/values-observer-iaas.yaml"})]}),"\n"]}),"\n",(0,o.jsx)(s.h4,{id:"access-the-openstack-dashboard",children:"Access the OpenStack dashboard"}),"\n",(0,o.jsx)(s.p,{children:"At this point, you should have the ability to access the Grafana UI, and OpenStack dashboard."}),"\n",(0,o.jsx)(s.p,{children:"Log in to the Grafana UI and find the OpenStack dashboard in IaaS directory:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"http://localhost:30000\n"})}),"\n",(0,o.jsx)(s.p,{children:"or directly access the OpenStack dashboard:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"http://localhost:30000/d/openstack-overview\n"})}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Use the following credentials:","\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["username: ",(0,o.jsx)(s.code,{children:"admin"})]}),"\n",(0,o.jsxs)(s.li,{children:["password: ",(0,o.jsx)(s.code,{children:"pass"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(s.h3,{id:"ceph",children:"Ceph"}),"\n",(0,o.jsxs)(s.p,{children:["The SCS IaaS reference implementation (OSISM) currently supports ",(0,o.jsx)(s.a,{href:"https://github.com/ceph/ceph-ansible",children:"ceph-ansible"}),"\nmethod for deploying Ceph. Support for the ",(0,o.jsx)(s.a,{href:"https://github.com/rook/rook",children:"rook operator"})," deployment method will be available ",(0,o.jsx)(s.a,{href:"https://github.com/osism/issues/issues/881",children:"soon"}),"."]}),"\n",(0,o.jsx)(s.p,{children:"This guide covers Ceph cluster monitoring for both deployment methods. While both expose the same metrics via the same\nendpoint, there are some differences in Prometheus configuration and alerts."}),"\n",(0,o.jsx)(s.h4,{id:"prometheus-metrics-and-alerts-1",children:"Prometheus metrics and alerts"}),"\n",(0,o.jsx)(s.p,{children:"Ceph contains 2 build-in sources of metrics a.k.a. exporters.\nThe Ceph exporter (introduced in Reef release of Ceph) is the main source of Ceph performance metrics. It runs as a\ndedicated daemon. This daemon runs on every Ceph cluster host and exposes a metrics end point where all the performance\ncounters exposed by all the Ceph daemons running in the host are published in the form of Prometheus metrics."}),"\n",(0,o.jsx)(s.p,{children:"The second source of metrics is the Prometheus manager module. It exposes metrics related to the whole cluster,\nbasically metrics that are not produced by individual Ceph daemons."}),"\n",(0,o.jsxs)(s.p,{children:["Read the related Ceph ",(0,o.jsx)(s.a,{href:"https://docs.ceph.com/en/reef/monitoring/#ceph-metrics",children:"docs"}),".\nSince these exporters are integrated with Ceph, deploying a third-party Ceph exporter is unnecessary."]}),"\n",(0,o.jsx)(s.p,{children:(0,o.jsx)(s.strong,{children:"Prometheus alerts"})}),"\n",(0,o.jsxs)(s.p,{children:["Both Ceph deployment strategies use the ceph-mixins project as a source of alerts. The ceph-ansible and rook projects\neach maintain a rendered version of these alerts, but the rook repository contains some differences, primarily because\nrook does not use the cephadm tool as a backend.\nTherefore, find and apply one of the following commands to create a custom observer rules values file for either the\nceph-ansible or ceph-rook deployment (",(0,o.jsx)(s.a,{href:"https://github.com/mikefarah/yq/#install",children:"yq"})," tool required):"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:'# ceph-ansible\ncurl -s https://raw.githubusercontent.com/ceph/ceph/main/monitoring/ceph-mixin/prometheus_alerts.yml | \\\n  yq \'{"kube-prometheus-stack": {"additionalPrometheusRulesMap": {"ceph-ansible-rules": (. + {"additionalLabels": {"prometheus_rule": "1"}})}}}\' > iaas/values-observer-ceph-rules.yaml\n\n# rook\ncurl -s https://raw.githubusercontent.com/rook/rook/master/deploy/charts/rook-ceph-cluster/prometheus/localrules.yaml | \\\n  yq \'{"kube-prometheus-stack": {"additionalPrometheusRulesMap": {"ceph-rook-rules": (. + {"additionalLabels": {"prometheus_rule": "1"}})}}}\' > iaas/values-observer-ceph-rules.yaml\n'})}),"\n",(0,o.jsx)(s.h4,{id:"grafana-dashboards-1",children:"Grafana dashboards"}),"\n",(0,o.jsx)(s.p,{children:"We've tested and could recommend 2 sources of Grafana dashboards that are suitable for both Ceph deployment strategies (ansible and rook):"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.a,{href:"https://rook.io/docs/rook/latest-release/Storage-Configuration/Monitoring/ceph-monitoring/?h=gra#grafana-dashboards",children:"dashboards linked in rook docs"})}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.a,{href:"https://github.com/ceph/ceph-mixins/tree/master/dashboards",children:"ceph-mixins dashboards"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Built version of ceph-mixins dashboards could be found e.g. ",(0,o.jsx)(s.a,{href:"https://github.com/ceph/ceph/tree/main/monitoring/ceph-mixin/dashboards_out",children:"here"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["We consider the dashboards created within the Rook project as a solid starting point for Ceph metrics visualization.\nIf you want to see more detailed dashboards, uncomment and use the ceph-mixin dashboards in the ",(0,o.jsx)(s.code,{children:"values-observer-ceph-rook.yaml"}),"\nor ",(0,o.jsx)(s.code,{children:"values-observer-ceph-ansible.yaml"})," file. You can use both."]}),"\n",(0,o.jsx)(s.h4,{id:"update-the-scs-monitoring-deployment-1",children:"Update the SCS monitoring deployment"}),"\n",(0,o.jsxs)(s.p,{children:["This step deploys Grafana dashboards, Prometheus rules and instruct monitoring stack to add the Ceph exporter targets into the Prometheus configuration.\nEnsure that you add the monitoring targets' IPs and ports to ",(0,o.jsx)(s.code,{children:"values-observer-ceph-ansible.yaml"})," for Ceph-ansible deployment."]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"helm upgrade dnation-kubernetes-monitoring-stack dnationcloud/dnation-kubernetes-monitoring-stack --reset-then-reuse-values \\\n  -f iaas/values-observer-ceph-rules.yaml \\\n  -f iaas/values-observer-ceph-[rook|ansible].yaml  # use values file for either the ceph-ansible or ceph-rook deployment\n"})}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Note: The ",(0,o.jsx)(s.code,{children:"--reset-then-reuse-values"})," option requires Helm v3.14.0 or later. Alternatively, you can use the original values\nby applying ",(0,o.jsx)(s.code,{children:"-f values-observer.yaml"}),", see full command: ",(0,o.jsx)(s.code,{children:"helm upgrade dnation-kubernetes-monitoring-stack dnationcloud/dnation-kubernetes-monitoring-stack -f values-observer.yaml -f iaas/values-observer-ceph-rules.yaml -f iaas/values-observer-ceph-[rook|ansible].yaml"})]}),"\n"]})]})}function d(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>i});var t=n(96540);const o={},r=t.createContext(o);function a(e){const s=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(r.Provider,{value:s},e.children)}}}]);