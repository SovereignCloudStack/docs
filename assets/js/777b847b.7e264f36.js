"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[79001],{30406:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"container/components/cluster-stacks/components/cluster-stacks/continuous-integration","title":"Continuous integration","description":"Project cluster-stacks use the SCS Zuul CI platform to","source":"@site/docs/03-container/components/cluster-stacks/components/cluster-stacks/continuous-integration.md","sourceDirName":"03-container/components/cluster-stacks/components/cluster-stacks","slug":"/container/components/cluster-stacks/components/cluster-stacks/continuous-integration","permalink":"/docs/container/components/cluster-stacks/components/cluster-stacks/continuous-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/SovereignCloudStack/docs/tree/main/docs/03-container/components/cluster-stacks/components/cluster-stacks/continuous-integration.md","tags":[],"version":"current","frontMatter":{}}');var i=s(74848),c=s(28453);const o={},l="Continuous integration",r={},a=[{value:"Configuration",id:"configuration",level:2},{value:"Pipelines",id:"pipelines",level:2},{value:"Jobs",id:"jobs",level:2},{value:"Secrets",id:"secrets",level:3},{value:"Job customization",id:"job-customization",level:3}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"continuous-integration",children:"Continuous integration"})}),"\n",(0,i.jsxs)(n.p,{children:["Project ",(0,i.jsx)(n.code,{children:"cluster-stacks"})," use the ",(0,i.jsx)(n.a,{href:"https://zuul.scs.community",children:"SCS Zuul"})," CI platform to\ndrive its continuous integration tests. The project is registered under the ",(0,i.jsx)(n.a,{href:"https://zuul.scs.community/t/SCS/projects",children:"SCS tenant"}),"\nand therefore is able to use a set of pre-defined pipelines, jobs, and ansible roles that the\nSCS Zuul instance defines and imports. If you want to explore currently available SCS pipelines,\nvisit the ",(0,i.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/zuul-config",children:"SCS zuul-config"})," project.\nIf you want to see the full list of jobs that are available, visit the ",(0,i.jsx)(n.a,{href:"https://zuul.scs.community/t/SCS/jobs",children:"SCS Zuul UI"}),".\nAnd if you are looking for some handy ansible role that SCS Zuul imports, visit the ",(0,i.jsx)(n.a,{href:"https://opendev.org/zuul/zuul-jobs/src/branch/master/roles",children:"source"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Refer to the SCS ",(0,i.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/docs/blob/main/contributor-docs/operations/operations/zuul-ci-cd-quickstart-user-guide.md",children:"Zuul users guide"})," and/or\n",(0,i.jsx)(n.a,{href:"https://zuul-ci.org/docs/",children:"Zuul docs"})," for further details on how to define and use Zuul\nCI/CD pipelines and jobs."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["[!NOTE]\nIf you are interested in the Zuul CI platform and want to deploy your own development instance of it,\nthen read the official ",(0,i.jsx)(n.a,{href:"https://zuul-ci.org/docs/zuul/latest/tutorials/quick-start.html",children:"quick-start"})," manual\nor visit ",(0,i.jsx)(n.a,{href:"https://github.com/matofederorg/zuul-config?tab=readme-ov-file#zuul-ci",children:"this"})," tutorial which aims a connect\nof Zuul CI platform with a GitHub organization."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["SCS Zuul automatically recognizes ",(0,i.jsx)(n.code,{children:".zuul.yaml"})," configuration file that is located in the\ncluster-stacks's root. This file informs Zuul about the project's ",(0,i.jsx)(n.a,{href:"https://zuul-ci.org/docs/zuul/latest/config/project.html#attr-project.default-branch",children:"default-branch"})," and\npreferred ",(0,i.jsx)(n.a,{href:"https://zuul-ci.org/docs/zuul/latest/config/project.html#attr-project.merge-mode",children:"merge-mode"}),".\nIt also references ",(0,i.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/zuul-config",children:"SCS Zuul pipelines"})," and\ntheir jobs used by the cluster-stacks project. Then, jobs link Ansible playbooks that contain\ntasks for actual CI testing."]}),"\n",(0,i.jsx)(n.p,{children:"See relevant CI configuration files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"\u251c\u2500\u2500 .zuul.yaml\n\u251c\u2500\u2500 playbooks\n\u2502   \u251c\u2500\u2500 dependencies.yaml\n\u2502   \u251c\u2500\u2500 openstack\n\u2502   \u2502   \u251c\u2500\u2500  e2e.yaml\n\u2502   \u2502   \u251c\u2500\u2500  templates\n\u2502   \u2502   \u2502    \u251c\u2500\u2500 mgmt-cluster-config.yaml.j2\n\u2502   \u2502   \u2502    \u251c\u2500\u2500 cluster.yaml.j2\n\u2502   \u2502   \u2502    \u2514\u2500\u2500 cluster-stack-template.yaml.j2\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pipelines",children:"Pipelines"}),"\n",(0,i.jsxs)(n.p,{children:["This section describes an ",(0,i.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/zuul-config/blob/main/zuul.d/gh_pipelines.yaml",children:"SCS Zuul pipelines"})," that are used by the cluster-stacks project."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"e2e-test"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["It is triggered by the ",(0,i.jsx)(n.code,{children:"e2e-test"})," label in the opened PR"]}),"\n",(0,i.jsxs)(n.li,{children:["It executes ",(0,i.jsx)(n.code,{children:"e2e-openstack-conformance"})," job"]}),"\n",(0,i.jsxs)(n.li,{children:["It applies the PR label ",(0,i.jsx)(n.code,{children:"successful-e2e-test"})," and leaves an informative PR comment when the ",(0,i.jsx)(n.code,{children:"e2e-openstack-conformance"})," job succeeded"]}),"\n",(0,i.jsxs)(n.li,{children:["It applies the PR label ",(0,i.jsx)(n.code,{children:"failed-e2e-test"})," and leaves an informative PR comment when the ",(0,i.jsx)(n.code,{children:"e2e-openstack-conformance"})," job failed"]}),"\n",(0,i.jsxs)(n.li,{children:["It applies the PR label ",(0,i.jsx)(n.code,{children:"cancelled-e2e-test"})," and leaves an informative PR comment when the ",(0,i.jsx)(n.code,{children:"e2e-openstack-conformance"})," job is canceled"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"unlabel-on-update-e2e-test"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["It is triggered by the PR update only when PR contains the ",(0,i.jsx)(n.code,{children:"successful-e2e-test"})," label"]}),"\n",(0,i.jsx)(n.li,{children:"It ensures that any PR update invalidates a previous successful e2e test"}),"\n",(0,i.jsxs)(n.li,{children:["It removes ",(0,i.jsx)(n.code,{children:"successful-e2e-test"})," label from the PR"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"e2e-quick-test"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["It is triggered by the ",(0,i.jsx)(n.code,{children:"e2e-quick-test"})," label in the opened PR"]}),"\n",(0,i.jsxs)(n.li,{children:["It executes ",(0,i.jsx)(n.code,{children:"e2e-openstack-quick"})," job"]}),"\n",(0,i.jsxs)(n.li,{children:["It applies the PR label ",(0,i.jsx)(n.code,{children:"successful-e2e-quick-test"})," and leaves an informative PR comment when the ",(0,i.jsx)(n.code,{children:"e2e-openstack-quick"})," job succeeded"]}),"\n",(0,i.jsxs)(n.li,{children:["It applies the PR label ",(0,i.jsx)(n.code,{children:"failed-e2e-quick-test"})," and leaves an informative PR comment when the ",(0,i.jsx)(n.code,{children:"e2e-openstack-quick"})," job failed"]}),"\n",(0,i.jsxs)(n.li,{children:["It applies the PR label ",(0,i.jsx)(n.code,{children:"cancelled-e2e-quick-test"})," and leaves an informative PR comment when the ",(0,i.jsx)(n.code,{children:"e2e-openstack-quick"})," job is canceled"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"unlabel-on-update-e2e-quick-test"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["It is triggered by the PR update only when PR contains the ",(0,i.jsx)(n.code,{children:"successful-e2e-quick-test"})," label"]}),"\n",(0,i.jsx)(n.li,{children:"It ensures that any PR update invalidates a previous successful e2e test"}),"\n",(0,i.jsxs)(n.li,{children:["It removes ",(0,i.jsx)(n.code,{children:"successful-e2e-quick-test"})," label from the PR"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"jobs",children:"Jobs"}),"\n",(0,i.jsx)(n.p,{children:"This section describes Zuul jobs defined within the cluster-stacks project and linked in the above pipelines."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"e2e-openstack-conformance"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"It runs a sonobuoy conformance test against Kubernetes cluster spawned by a specific cluster-stack"}),"\n",(0,i.jsxs)(n.li,{children:["This job is a child job of ",(0,i.jsx)(n.code,{children:"openstack-access-base"})," that ensures OpenStack credentials\navailability in Zuul worker node. Parent job also defines a Zuul semaphore ",(0,i.jsx)(n.code,{children:"semaphore-openstack-access"}),",\nthat ensures that a maximum of three ",(0,i.jsx)(n.code,{children:"openstack-access-base"})," jobs (or their children) can run at a time"]}),"\n",(0,i.jsxs)(n.li,{children:["See a high level ",(0,i.jsx)(n.code,{children:"e2e-openstack-conformance"})," job steps:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Pre-run playbook ",(0,i.jsx)(n.code,{children:"dependencies.yaml"})," installs project prerequisites, e.g. clusterctl, KinD, csctl, etc."]}),"\n",(0,i.jsxs)(n.li,{children:["Main playbook ",(0,i.jsx)(n.code,{children:"e2e.yaml"})," spawns a k8s workload cluster using a specific cluster-stack in OpenStack, runs sonobuoy conformance test, SCS compliance test, and cleans created k8s workload cluster"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"e2e-openstack-quick"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"It runs a sonobuoy quick test against Kubernetes cluster spawned by a specific cluster-stack"}),"\n",(0,i.jsxs)(n.li,{children:["This job is a child job of ",(0,i.jsx)(n.code,{children:"openstack-access-base"})," that ensures OpenStack credentials\navailability in Zuul worker node. Parent job also defines a Zuul semaphore ",(0,i.jsx)(n.code,{children:"semaphore-openstack-access"}),",\nthat ensures that a maximum of three ",(0,i.jsx)(n.code,{children:"openstack-access-base"})," jobs (or their children) can run at a time"]}),"\n",(0,i.jsxs)(n.li,{children:["See a high level ",(0,i.jsx)(n.code,{children:"e2e-openstack-quick"})," job steps:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Pre-run playbook ",(0,i.jsx)(n.code,{children:"dependencies.yaml"})," installs project prerequisites, e.g. clusterctl, KinD, csctl, etc."]}),"\n",(0,i.jsxs)(n.li,{children:["Main playbook ",(0,i.jsx)(n.code,{children:"e2e.yaml"})," spawns a k8s workload cluster using a specific cluster-stack in OpenStack, runs sonobuoy quick test, SCS compliance test, and cleans created k8s workload cluster"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"secrets",children:"Secrets"}),"\n",(0,i.jsxs)(n.p,{children:["The parent job ",(0,i.jsx)(n.code,{children:"openstack-access-base"}),", from which e2e jobs inherit, defines the secret variable ",(0,i.jsx)(n.code,{children:"openstack-application-credential"}),".\nThis secret is stored directly in the ",(0,i.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/zuul-config/blob/main/zuul.d/secrets.yaml",children:"SCS/zuul-config repository"})," in an encrypted form. It contains OpenStack application credentials to access the OpenStack project dedicated to CI testing."]}),"\n",(0,i.jsxs)(n.p,{children:["This secret is encrypted by the SCS/zuul-config repository RSA key that has been generated by SCS Zuul instance.\nSo only SCS Zuul instance is able to decrypt it (read the ",(0,i.jsx)(n.a,{href:"https://zuul-ci.org/docs/zuul/latest/project-config.html#encryption",children:"docs"}),")."]}),"\n",(0,i.jsx)(n.p,{children:"If you want to re-generate the mentioned secret or add another one using SCS/zuul-config repository RSA key, follow the below instructions:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Install zuul-client"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pip install zuul-client\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Encrypt "super-secret" string by the SCS/zuul-config repository public key from SCS Zuul'}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'echo -n "super-secret" | \\\n  zuul-client --zuul-url https://zuul.scs.community encrypt \\\n  --tenant SCS \\\n  --project github.com/SovereignCloudStack/zuul-config\n'})}),"\n",(0,i.jsx)(n.h3,{id:"job-customization",children:"Job customization"}),"\n",(0,i.jsxs)(n.p,{children:["In a pull request (PR), you may want to run the end-to-end (e2e) test against the specific cluster-stack you are changing or adding, without modifying the ",(0,i.jsx)(n.code,{children:"cluster_stack"})," variable in the ",(0,i.jsx)(n.code,{children:"e2e.yaml"})," file in the repository."]}),"\n",(0,i.jsx)(n.p,{children:"To achieve this, include the following text in the body of the PR:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:'    ```ZUUL_CONFIG\n    cluster_stack = "openstack-alpha-1-29"\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n> [!NOTE]\n> Please note that only cluster-stacks for OpenStack are currently supported.\n\n### FAQ\n\n#### How do developers/reviewers should proceed if they want to CI test this project?\n\nA developer initiates a PR as usual. If a reviewer deems that the PR requires e2e testing, they can apply a specific label to the PR. Currently, the following labels could be applied:\n\n- `e2e-test` (for comprehensive end-to-end (e2e) testing, including Kubernetes (k8s) workload cluster creation, execution of Sonobuoy conformance and SCS compliance tests, and cluster deletion.)\n- `e2e-quick-test` (for comprehensive end-to-end (e2e) testing, including Kubernetes (k8s) workload cluster creation, execution of Sonobuoy quick and SCS compliance tests, and cluster deletion.)\n\nAfter the e2e test has completed, the reviewer can examine the test results and respond accordingly, such as approving the PR if everything appears to be in order or requesting changes. Sonobuoy test results, along with a link to the e2e logs, are conveyed back to the PR via a comment. Additionally, the PR is labeled appropriately based on the overall e2e test results, using labels like\n`successful-e2e-test`, `successful-e2e-quick-test`, `failed-e2e-test`, or `failed-e2e-quick-test`.\n\n#### Why do we use PR `label` as an e2e pipeline trigger instead of e.g. PR `comment`?\n\nWe consider PR labels to be a more secure pipeline trigger compared to, for example, PR comments.\nPR labels can only be applied by developers with [triage](https://docs.github.com/en/organizations/managing-user-access-to-your-organizations-repositories/managing-repository-roles/repository-roles-for-an-organization#permissions-for-each-role) repository access or higher.\nIn contrast, PR comments can be added by anyone with a GitHub account.\n\nMembers of the SCS GitHub organization are automatically granted 'write' access to SCS repositories. Consequently, the PR label mechanism ensures that only SCS organization members can trigger e2e pipelines.\n\n#### How do we ensure that any PR update invalidates a previous successful e2e test?\n\nIn fact, two mechanisms ensure the invalidation of a previously successful test when a PR is updated.\n\nFirstly, the pipelines `unlabel-on-update-<e2e-test-name>` remove the `successful-<e2e-test-name>` label\nfrom the PR when it's updated after a successful e2e test has finished. If an e2e test is in progress and the PR is updated, the currently running e2e test is canceled, the `successful-<e2e-test-name>` label is removed (if it exists), and the `cancelled-<e2e-test-name>` label is applied along with an informative PR comment to inform the reviewer about the situation.\n"})})]})}function d(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var t=s(96540);const i={},c=t.createContext(i);function o(e){const n=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);