"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[68868],{59553:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"usage-hints/find-image/index","title":"Locating provider-managed images","description":"Purpose","source":"@site/user-docs/usage-hints/find-image/index.md","sourceDirName":"usage-hints/find-image","slug":"/usage-hints/find-image/","permalink":"/user-docs/usage-hints/find-image/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"layout":"post","title":"Locating provider-managed images","author":["Kurt Garloff"],"avatar":["kgarloff.jpg"]},"sidebar":"userDocs","previous":{"title":"Overview","permalink":"/user-docs/usage-hints/"},"next":{"title":"Preferring diskless flavors in SCS","permalink":"/user-docs/usage-hints/diskless-flavor/"}}');var i=t(74848),a=t(28453);const o={layout:"post",title:"Locating provider-managed images",author:["Kurt Garloff"],avatar:["kgarloff.jpg"]},r=void 0,d={},c=[{value:"Purpose",id:"purpose",level:2},{value:"The new <code>os_purpose</code> property",id:"the-new-os_purpose-property",level:2},{value:"Identifying the right image using python (openstack-SDK)",id:"identifying-the-right-image-using-python-openstack-sdk",level:2},{value:"Identifying the image with OpenStack CLI",id:"identifying-the-image-with-openstack-cli",level:2},{value:"opentofu / terraform",id:"opentofu--terraform",level:2},{value:"heat",id:"heat",level:2},{value:"ansible",id:"ansible",level:2},{value:"Horizon Web Interface (GUI)",id:"horizon-web-interface-gui",level:2},{value:"Skyline Web Interface (GUI)",id:"skyline-web-interface-gui",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"purpose",children:"Purpose"}),"\n",(0,i.jsxs)(n.p,{children:["Many providers provide public images that they maintain for user convenience.\nMaintenance means that they regularly update it to include the latest bug- and\nsecurity fixes. The exact policy is transparent from the image metadata as\nspecified in SCS standard ",(0,i.jsx)(n.a,{href:"https://docs.scs.community/standards/iaas/scs-0102",children:"scs-0102"}),".\nA few images have to be managed this way by the provider according to\n",(0,i.jsx)(n.a,{href:"https://docs.scs.community/standards/iaas/scs-0104",children:"scs-0104"}),".\nPreviously (with ",(0,i.jsx)(n.a,{href:"https://docs.scs.community/standards/scs-0102-v1-image-metadata",children:"scs-0102-v1"}),")\nthe image could be referenced by a standard name to always get the current\nimage whereas a reference by UUID would result in an unchanged image (until\nit is removed according to the provider's policy that is transparent from\nthe metadata)."]}),"\n",(0,i.jsx)(n.p,{children:'Some providers prefer to use different image names. We intend to allow this with\nscs-0102-v2.\nThis however means that identifying the most recent "Ubuntu 24.04" image on\nan SCS-compatible IaaS cloud becomes a bit harder in a portable way.\nThis article describes how to do this.'}),"\n",(0,i.jsxs)(n.h2,{id:"the-new-os_purpose-property",children:["The new ",(0,i.jsx)(n.code,{children:"os_purpose"})," property"]}),"\n",(0,i.jsxs)(n.p,{children:["While we suggest to rename or better to hide old images, there can still legitimately\nbe several variants of images, e.g. minimal variants or Kubernetes node images etc.\nThese must not be confused with the standard general purpose images. To avoid\nconfusion, we have introduced a new ",(0,i.jsx)(n.code,{children:"os_purpose"})," (recommended in v1.1 of scs-0102\nand mandatory in v2) field, that can be set to ",(0,i.jsx)(n.code,{children:"generic"}),", ",(0,i.jsx)(n.code,{children:"minimal"}),", ",(0,i.jsx)(n.code,{children:"k8snode"}),",\n",(0,i.jsx)(n.code,{children:"gpu"}),", ",(0,i.jsx)(n.code,{children:"network"}),", or ",(0,i.jsx)(n.code,{children:"custom"})," according to scs-0102-v2.\nTo now find the latest general purpose Ubuntu Noble Numbat 24.04 image, one can search the\nimage catalog for ",(0,i.jsx)(n.code,{children:"os_distro=ubuntu"}),", ",(0,i.jsx)(n.code,{children:"os_version=24.04"}),", and ",(0,i.jsx)(n.code,{children:"os_purpose=generic"}),".\nThis is straightforward if all SCS clouds already comply to the new metadata standard\nand only have one matching image.\nIt's a bit more complex in case we have to deal with a mixture of old and new ..."]}),"\n",(0,i.jsx)(n.h2,{id:"identifying-the-right-image-using-python-openstack-sdk",children:"Identifying the right image using python (openstack-SDK)"}),"\n",(0,i.jsx)(n.p,{children:"To find the Ubuntu 24.04 generic image, we would just do"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'    images = [x for x in conn.image.images(os_distro=distro, os_version=version,\n                                           sort="name:desc,created_at:desc")\n              if x.properties.get("os_purpose") == purpose]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["where ",(0,i.jsx)(n.code,{children:"conn"})," is a connection to your OpenStack project and ",(0,i.jsx)(n.code,{children:"distro"}),", ",(0,i.jsx)(n.code,{children:"version"})," and\n",(0,i.jsx)(n.code,{children:"purpose"})," have been set to the lowercase strings you are looking for."]}),"\n",(0,i.jsx)(n.p,{children:"Three notes:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["We use a list comprehension to filter for ",(0,i.jsx)(n.code,{children:"os_purpose"})," because ",(0,i.jsx)(n.code,{children:"os_purpose"}),"\nis not one of the hardcoded properties that the SDK knows unlike ",(0,i.jsx)(n.code,{children:"os_distro"}),"\nand ",(0,i.jsx)(n.code,{children:"os_version"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["We can add additional filtering such as ",(0,i.jsx)(n.code,{children:'visibility="public"'})," if we just want\nto look for public images."]}),"\n",(0,i.jsx)(n.li,{children:'We sort the list, so in case we have several matches, we want the images grouped\nby image name and within the same name have the latest images first. This would\ntypically put the latest image first in the case where a provider renames old\nimages "Ubuntu 24.04" to "Ubuntu 24.04 timestamp" or fails to rename them.\n(The latter would not be compliant with scs-0102.)'}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["It gets a bit harder when you want SCS clouds that comply to the old v1 standard\nand do not yet have the ",(0,i.jsx)(n.code,{children:"os_purpose"})," field set. Above call then returns an empty\nlist. We then would fall back to look for images that match ",(0,i.jsx)(n.code,{children:"os_distro"})," and\n",(0,i.jsx)(n.code,{children:"os_version"}),", but have no ",(0,i.jsx)(n.code,{children:"os_purpose"})," property."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'        images = [x for x in conn.image.images(os_distro=distro, os_version=version,\n                                               sort="name:desc,created_at:desc")\n                  if "os_purpose" not in x.properties]\n'})}),"\n",(0,i.jsx)(n.p,{children:"We have to expect several matches here and need some heuristic to find the\nright image, preferrably the one matching the old naming convention."}),"\n",(0,i.jsxs)(n.p,{children:["Full code that does this is available in ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:t(78912).A+"",children:"find_img.py"}),".\nThe script assume that you have set your ",(0,i.jsx)(n.code,{children:"OS_CLOUD"})," environment variable\nand have configured working ",(0,i.jsx)(n.code,{children:"clouds.yaml"})," and ",(0,i.jsx)(n.code,{children:"secure.yaml"}),".\nFeel free to copy, I deliberately put this under MIT license."]}),"\n",(0,i.jsx)(n.h2,{id:"identifying-the-image-with-openstack-cli",children:"Identifying the image with OpenStack CLI"}),"\n",(0,i.jsxs)(n.p,{children:["Unlike with Python, we can pass the ",(0,i.jsx)(n.code,{children:"os_purpose"})," field just like the other\nproperties."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'openstack image list --property os_distro="$DIST" --property os_version="$VERS" \\\n--property os_purpose="$PURP" -f value -c ID -c Name --sort name:desc,created_at:desc\n'})}),"\n",(0,i.jsxs)(n.p,{children:["where ",(0,i.jsx)(n.code,{children:"OS_CLOUD"})," environment has been configured to access your cloud project and\n",(0,i.jsx)(n.code,{children:"DIST"}),", ",(0,i.jsx)(n.code,{children:"VERS"})," and ",(0,i.jsx)(n.code,{children:"PURP"})," are set to the lowercased image properties you\nare looking for. An additional filter ",(0,i.jsx)(n.code,{children:"--public"})," parameter could be passed to only\nlist public images. See above python comment for the sorting rationale."]}),"\n",(0,i.jsxs)(n.p,{children:["Dealing with old SCS clouds (not yet implementing v2 of scs-0102) is harder\nwith shell code. The reason is that we can not pass a flag to ",(0,i.jsx)(n.code,{children:"openstack image list"})," that would tell it to restrict results to records without an\n",(0,i.jsx)(n.code,{children:"os_purpose"})," property. So this requires looping over the images and filtering\nout all images with ",(0,i.jsx)(n.code,{children:"os_purpose"})," (but not matching our request). We would\nhave to expect several matches now again and sort them by a heuristic,\nsomewhat similar (but not identical) to the python code."]}),"\n",(0,i.jsxs)(n.p,{children:["Full code that does this is available in ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:t(67304).A+"",children:"find_img.sh"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"opentofu--terraform",children:"opentofu / terraform"}),"\n",(0,i.jsx)(n.p,{children:"With opentofu (or Hashicorp's terraform if you still use it), identifying\nthe image in an HCL recipe looks like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# Find the image\ndata "openstack_images_image_v2" "my_image" {\n  most_recent = true\n\n  properties  = {\n    os_distro       = "ubuntu"\n    os_version      = "24.04"\n    os_purpose      = "generic"\n  }\n  # sort             = "name:desc,created_at:desc"\n  # sort_key          = "name"\n  # sort_direction    = "desc"\n}\n\n# Use the selected image\nresource "openstack_compute_instance_v2" "instance" {\n  image_id          = data.openstack_images_image_v2.my_image.id\n  ...\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This will find the most recent image wtih the ",(0,i.jsx)(n.code,{children:"os_"})," variables set to ",(0,i.jsx)(n.code,{children:"ubuntu"}),", ",(0,i.jsx)(n.code,{children:"24.04"}),", ",(0,i.jsx)(n.code,{children:"generic"}),".\nNote that unlike the python and shell examples, we can not easily sort for name and creation\ndate at the same time; the only option to deal with several matches is to tell opentofu's\nopenstack provider to return the latest (the one with the newest ",(0,i.jsx)(n.code,{children:"created_at"})," date)."]}),"\n",(0,i.jsxs)(n.p,{children:["An example can be found in ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:t(31099).A+"",children:"find_img.tf"}),". Call it with ",(0,i.jsx)(n.code,{children:"tofu apply -auto-approve"}),"\n(after you ran ",(0,i.jsx)(n.code,{children:"tofu init"})," in this directory once)."]}),"\n",(0,i.jsxs)(n.p,{children:["The fallback to name matching for clouds that don't have ",(0,i.jsx)(n.code,{children:"os_purpose"})," yet is harder."]}),"\n",(0,i.jsxs)(n.p,{children:["We use an external program, the python script from before to select the right image and just create\na little wrapper around it: ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:t(86104).A+"",children:"find_img2.py"}),". The HCL then looks like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# Call python find_img.py to find best image\ndata "external" "my_image2" {\n  program = ["python3", "${path.module}/find_img2.py"]\n\n  query = {\n    os_distro        = "${var.os_distro2}"\n    os_version       = "${var.os_version2}"\n    os_purpose       = "${var.os_purpose2}"\n  }\n}\n\n# Output the results for inspection\noutput "selected_image2" {\n  value = {\n    id   = data.external.my_image2.result.image_id\n    name = data.external.my_image2.result.image_name\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The HCL is in ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:t(49571).A+"",children:"find_img2.tf"}),".\nNote that I have appended a ",(0,i.jsx)(n.code,{children:"2"})," to the variable names, so they don't clash in case you have the\noriginal example in the same directory."]}),"\n",(0,i.jsx)(n.h2,{id:"heat",children:"heat"}),"\n",(0,i.jsx)(n.p,{children:"I did not find a good way to select an image based on its properties in heat.\nObviously, you can use the python (or shell) script above and pass the image name\nor ID as a parameter when invoking heat."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"heat_template_version: 2018-08-31\n\nparameters:\n  image:\n    type: string\n    description: Image ID or name\n    constraints:\n      - custom_constraint: glance.image\n\nresources:\n  my_instance:\n    type: OS::Nova::Server\n    properties:\n      image: { get_param: image }\n      # ... other properties\n"})}),"\n",(0,i.jsxs)(n.p,{children:["and call ",(0,i.jsx)(n.code,{children:"openstack stack create --parameter image=$IMAGE_ID $TEMPLATE $STACKNAME"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"ansible",children:"ansible"}),"\n",(0,i.jsx)(n.p,{children:"Finding the right image in ansible can be done with a task that matches the properties\nin a straight forward way."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"---\n- name: Select Image with purpose\n  hosts: localhost\n  gather_facts: false\n  vars:\n    # Primary selection criteria\n    os_version: '24.04'\n    os_distro: 'ubuntu'\n    os_purpose: 'generic'\n    cloud_name: \"{{ lookup('env', 'OS_CLOUD') | default('openstack') }}\"\n\n  tasks:\n    - name: Get available images matching os_distro and os_version and os_purpose\n      openstack.cloud.image_info:\n        cloud: '{{ cloud_name }}'\n        properties:\n          os_distro: '{{ os_distro }}'\n          os_version: '{{ os_version }}'\n      register: _distro_images\n    - name: Select image with proper multi-key sort (single task)\n      set_fact:\n        selected_image: >-\n          {{\n            _distro_images.images\n            | selectattr('properties.os_purpose', 'defined')\n            | selectattr('properties.os_purpose', 'equalto', os_purpose)\n            | list\n            | sort(attribute='created_at', reverse=true)\n            | sort(attribute='name', reverse=true)\n            | first\n          }}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The fallback to name matching (for older clouds not yet complying to scs-0102-v2)\ncan be done in ansible, but gets a bit complex. Find the ansible tasks in\n",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:t(51564).A+"",children:"find_img.yaml"}),".\nSo, while ansible YAML proves to be more expressive than HCL here, the by far\nsimplest code is the python implementation."]}),"\n",(0,i.jsx)(n.p,{children:"Transparency hint: The ansible YAML has been produced with the help of Claude AI.\nI tested (and fixed) it."}),"\n",(0,i.jsx)(n.h2,{id:"horizon-web-interface-gui",children:"Horizon Web Interface (GUI)"}),"\n",(0,i.jsxs)(n.p,{children:["If you are using the Horizon GUI, you may be able to manually determin which\nimage is the one you want to use. To make sure and systematically analyze it by\nlooking at ",(0,i.jsx)(n.code,{children:"os_distro"}),", ",(0,i.jsx)(n.code,{children:"os_version"})," and ",(0,i.jsx)(n.code,{children:"os_purpose"}),", you need to go to\nCompute, Images, click on the Image. You can see all metadata, see screenshot."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Horizon Image Details",src:t(74674).A+"",width:"1990",height:"1442"})}),"\n",(0,i.jsx)(n.h2,{id:"skyline-web-interface-gui",children:"Skyline Web Interface (GUI)"}),"\n",(0,i.jsx)(n.p,{children:"This is similar to Horizon, you go to Compute, Images, Public Images tab,\nclick on image ID. See screenshot."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Skyline Image Details",src:t(79310).A+"",width:"1990",height:"1442"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},78912:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/files/find_img-68af949326812de36767aa430ae4c0cf.py"},67304:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/files/find_img-ee2cc97a34768ab94e714d560f636edf.sh"},31099:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/files/find_img-f5431537e71325d54d852cc73a1e8dd9.tf"},51564:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/files/find_img-4bc31af5ac947160ac1ab71a9cb4fbd3.yaml"},86104:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/files/find_img2-36159fc534e788b0581a87117b410ba6.py"},49571:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/files/find_img2-22f52848e34f12936d43c8e779ee4980.tf"},74674:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/horizon-66c6bf59c3d64719db366ff145f78173.png"},79310:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/skyline-dc70fea5a054cb66bd1122e1471ccefd.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var s=t(96540);const i={},a=s.createContext(i);function o(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);