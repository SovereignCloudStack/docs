"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[24984],{16347:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"container/components/container-registry/docs/backup_and_restore","title":"Backup and restore","description":"This page aims at providing a step-by-step guide for backup and restore Harbor","source":"@site/docs/03-container/components/container-registry/docs/backup_and_restore.md","sourceDirName":"03-container/components/container-registry/docs","slug":"/container/components/container-registry/docs/backup_and_restore","permalink":"/docs/container/components/container-registry/docs/backup_and_restore","draft":false,"unlisted":false,"editUrl":"https://github.com/SovereignCloudStack/docs/tree/main/docs/03-container/components/container-registry/docs/backup_and_restore.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Upgrade","permalink":"/docs/container/components/container-registry/docs/upgrade"},"next":{"title":"Migration","permalink":"/docs/container/components/container-registry/docs/migration"}}');var t=s(74848),a=s(28453);const o={},i="Backup and restore",c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Kubernetes cluster",id:"kubernetes-cluster",level:3},{value:"S3 bucket and EC2 credentials",id:"s3-bucket-and-ec2-credentials",level:3},{value:"Velero client",id:"velero-client",level:3},{value:"Velero server",id:"velero-server",level:3},{value:"Backup and restore",id:"backup-and-restore-1",level:2},{value:"Backup Harbor Instance",id:"backup-harbor-instance",level:3},{value:"Restore Harbor Instance",id:"restore-harbor-instance",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"backup-and-restore",children:"Backup and restore"})}),"\n",(0,t.jsxs)(n.p,{children:["This page aims at providing a step-by-step guide for backup and restore ",(0,t.jsx)(n.a,{href:"https://goharbor.io/",children:"Harbor"}),"\ncontainer registry using ",(0,t.jsx)(n.a,{href:"https://velero.io/",children:"Velero"})," tool.\nIt extends the official ",(0,t.jsx)(n.a,{href:"https://goharbor.io/docs/main/administration/backup-restore/",children:"Harbor backup-restore docs page"}),"\nwith up-to-date commands, explanations, and an extensive prerequisites section. This\nguide references and uses Velero in ",(0,t.jsx)(n.a,{href:"https://github.com/vmware-tanzu/velero/releases/tag/v1.10.2",children:"v1.10.2"}),"\nas this is the latest stable version at the time of writing this guide."]}),"\n",(0,t.jsx)(n.p,{children:"It provides guidance and commands that readers are encouraged to try out by themselves\non Harbor deployment as described in the next sections. It does not aim at providing an\nexhaustive list of commands nor all the possible ways how to use them."}),"\n",(0,t.jsx)(n.p,{children:"The guide covers two strategies to save Harbor data:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Backup: a regular backup created by the ",(0,t.jsx)(n.a,{href:"https://restic.net/",children:"restic"})," integration in Velero as described in the related ",(0,t.jsx)(n.a,{href:"https://velero.io/docs/main/file-system-backup/",children:"docs"})]}),"\n",(0,t.jsxs)(n.li,{children:["Snapshot: a point-in-time snapshot be the Container Storage Interface (CSI) snapshot support in Velero as described in the related ",(0,t.jsx)(n.a,{href:"https://velero.io/docs/main/csi/",children:"docs"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Before you choose the right strategy for your Harbor deployment backup, make sure that you understand\n",(0,t.jsx)(n.a,{href:"https://www.terra-master.com/global/snapshot",children:"differences"})," between the backup and snapshot.\nIn general, for long-term protection of Harbor data, you may use backup and for\ntemporary protection of data (e.g. before Harbor upgrade) you may use snapshot."]}),"\n",(0,t.jsxs)(n.p,{children:["Note that this guide is not limited to Harbor deployments that utilize SCS environments,\nbut it is required to have a set of tools and services (e.g. Kubernetes CSI plugin with volume snapshot\nsupport, S3 compatible object store for backups) for successful backup and restore procedure\n(see the ",(0,t.jsx)(n.a,{href:"#prerequisites",children:"prerequisites"})," section). These tools and services come out of\nthe box when the SCS infrastructure and KaaS are used for Harbor deployment, hence it is\nconvenient to use them."]}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsx)(n.h3,{id:"kubernetes-cluster",children:"Kubernetes cluster"}),"\n",(0,t.jsxs)(n.p,{children:["If you want to use ",(0,t.jsx)(n.code,{children:"snapshot"})," to back up Harbor data ensure the following:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Your cluster is Kubernetes version 1.20 or greater"}),"\n",(0,t.jsxs)(n.li,{children:["Your cluster is running a ",(0,t.jsx)(n.a,{href:"https://kubernetes-csi.github.io/docs/drivers.html",children:"CSI driver"}),"\ncapable of support volume snapshots at the ",(0,t.jsx)(n.a,{href:"https://kubernetes.io/blog/2020/12/10/kubernetes-1.20-volume-snapshot-moves-to-ga/",children:"v1 API level"}),".\nTo enable creating volume snapshots, the ",(0,t.jsx)(n.a,{href:"https://kubernetes-csi.github.io/docs/snapshot-controller.html",children:"snapshot-controller"}),"\nand its CRDs should be deployed in the Kubernetes cluster as well. The snapshot-controller\nis independent of any CSI Driver. These prerequisites come out of the box with the SCS KaaS solution."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["If you want to create Harbor ",(0,t.jsx)(n.code,{children:"backup"})," ensure the following:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Your cluster is Kubernetes version 1.16 or greater"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["If your cluster meets the above, export its kubeconfig path in env. variable ",(0,t.jsx)(n.code,{children:"KUBECONFIG"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"export KUBECONFIG=/path/to/kubeconfig\n"})}),"\n",(0,t.jsx)(n.h3,{id:"s3-bucket-and-ec2-credentials",children:"S3 bucket and EC2 credentials"}),"\n",(0,t.jsx)(n.p,{children:"This guide assumes that the public cloud's object store with S3-compatible API is available as\nthe storage backend for Velero. In this guide, we are using OpenStack Swift which\noffers S3-compatible API. Let's create an S3 bucket on Swift object storage and EC2 credentials\nthat will be later used by Velero."}),"\n",(0,t.jsx)(n.p,{children:"You should have access to your OpenStack project, and the OpenStack RC file that contains access\nvalues. Set the environment variables by sourcing the OpenStack RC file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"source <project>-openrc.sh\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Swift object store service does not support application credentials authentication\nto access S3 API. To authenticate in S3 API, you should generate and use the EC2 credentials\nmechanism.\nNote that EC2 credentials are associated with a user and are scoped only to a specific project.\nEC2 credentials are not protected by limited roles, expiration time, or\naccess rules, therefore they have the same access as the user who created them. If you\nwant to restrict EC2 credentials you could use application credentials for their creation,\nthen EC2 credentials should inherit a (potentially) limited subset of roles that creator\nowns (see ",(0,t.jsx)(n.a,{href:"https://opendev.org/openstack/keystone/commit/487c7276c7608fb11086b9875b0d7cc7cf594a5a",children:"this"})," for details)."]}),"\n",(0,t.jsx)(n.p,{children:"You can generate EC2 credentials as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ openstack ec2 credentials create\n+------------+----------------------------------------------------------------------------------------------------------+\n| Field      | Value                                                                                                    |\n+------------+----------------------------------------------------------------------------------------------------------+\n| access     | <aws_access_key_id>                                                                                      |\n| links      | {'self': 'https://api.gx-scs.sovereignit.cloud:5000/v3/users/<user_id>/credentials/OS-EC2/<project_id>'} |\n| project_id | <project_id>                                                                                             |\n| secret     | <aws_secret_access_key>                                                                                  |\n| trust_id   | None                                                                                                     |\n| user_id    | <user_id>                                                                                                |\n+------------+----------------------------------------------------------------------------------------------------------+\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Write down ",(0,t.jsx)(n.code,{children:"aws_access_key_id"})," and ",(0,t.jsx)(n.code,{children:"aws_secret_access_key"})," values from the output of ",(0,t.jsx)(n.code,{children:"openstack ec2 credentials create"}),"\ncommand and store them in the ",(0,t.jsx)(n.code,{children:"~/.aws/credentials"})," file as follows:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mkdir ~/.aws\ncat >~/.aws/credentials <<EOF\n[default]\naws_access_key_id = <aws_access_key_id>\naws_secret_access_key = <aws_secret_access_key>\nEOF\n"})}),"\n",(0,t.jsx)(n.p,{children:"This credential file is then used as an access and secret source for AWS CLI tool and also\nas a source for Velero. If your environment does not have AWS CLI installed, install it as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"pip3 install awscli awscli-plugin-endpoint\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Finally, create a new bucket. Note that the following command contains ",(0,t.jsx)(n.code,{children:"endpoint-url"}),"\nargument that points AWS CLI to the GX-SCS OpenStack Swift object store API."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws --endpoint-url https://api.gx-scs.sovereignit.cloud:8080 s3 mb s3://velero-backup\n"})}),"\n",(0,t.jsx)(n.h3,{id:"velero-client",children:"Velero client"}),"\n",(0,t.jsxs)(n.p,{children:["In this guide, we are using ",(0,t.jsx)(n.a,{href:"https://velero.io/",children:"Velero"})," to back up and restore a Harbor instance.\nVelero is an open source tool to safely back up and restore, perform disaster recovery,\nand migrate Kubernetes cluster resources."]}),"\n",(0,t.jsxs)(n.p,{children:["Go through the ",(0,t.jsx)(n.a,{href:"https://velero.io/docs/main/basic-install/",children:"official docs"})," and\ninstall the Velero client on your desired environment. If your environment is Linux distribution\nyou can use the following steps and install the Velero client from the GitHub release binaries:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"wget https://github.com/vmware-tanzu/velero/releases/download/v1.10.2/velero-v1.10.2-linux-amd64.tar.gz \ntar -zxvf velero-v1.10.2-linux-amd64.tar.gz \nsudo mv velero-v1.10.2-linux-amd64/velero /usr/local/bin/\n"})}),"\n",(0,t.jsx)(n.h3,{id:"velero-server",children:"Velero server"}),"\n",(0,t.jsxs)(n.p,{children:["Install Velero server components along with the appropriate plugins, into the Kubernetes cluster.\nThis will create a namespace called ",(0,t.jsx)(n.code,{children:"velero"}),", and place a deployment named ",(0,t.jsx)(n.code,{children:"velero"})," in it.\nNote that the installation command sets the bucket ",(0,t.jsx)(n.code,{children:"velero-backup"})," that has been created a few steps\nearlier as well as EC2 credentials located in ",(0,t.jsx)(n.code,{children:"~/.aws/credentials"})," file. Also note that\nthe ",(0,t.jsx)(n.code,{children:"region"})," and ",(0,t.jsx)(n.code,{children:"s3Url"})," parameters are GX-SCS specific. For further details about installation\noptions, supported storage providers, and more visit the official Velero ",(0,t.jsx)(n.a,{href:"https://velero.io/docs/",children:"docs"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["If you want to use ",(0,t.jsx)(n.code,{children:"snapshot"})," to back up Harbor data:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Install Velero:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:' velero install \\\n   --features=EnableCSI \\\n   --provider aws \\\n   --plugins velero/velero-plugin-for-aws:v1.6.1,velero/velero-plugin-for-csi:v0.4.2 \\\n   --bucket velero-backup \\\n   --secret-file ~/.aws/credentials \\\n   --backup-location-config region=RegionOne,s3ForcePathStyle="true",s3Url=https://api.gx-scs.sovereignit.cloud:8080 \\\n   --snapshot-location-config region=RegionOne,enableSharedConfig=true\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"In order to allow Velero to do Volume Snapshots, we need to deploy a new VolumeSnapshotClass. Create a velero-snapclass.yaml file as follows:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'cat > velero-snapclass.yaml << EOF\napiVersion: snapshot.storage.k8s.io/v1\ndeletionPolicy: Delete\ndriver: cinder.csi.openstack.org\nkind: VolumeSnapshotClass\nmetadata:\n  name: csi-cinder-snapclass-in-use-v1-velero\n  labels:\n    velero.io/csi-volumesnapshot-class: "true"\nparameters:\n  force-create: "true"\nEOF\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Apply the new class:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f velero-snapclass.yaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["If you want to create Harbor ",(0,t.jsx)(n.code,{children:"backup"})," with Restic:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Install Velero:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'velero install \\\n  --provider aws \\\n  --plugins velero/velero-plugin-for-aws:v1.6.1 \\\n  --bucket velero-backup \\\n  --secret-file ~/.aws/credentials \\\n  --use-volume-snapshots=false \\\n  --uploader-type=restic \\\n  --use-node-agent \\\n  --backup-location-config region=RegionOne,s3ForcePathStyle="true",s3Url=https://api.gx-scs.sovereignit.cloud:8080\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"backup-and-restore-1",children:"Backup and restore"}),"\n",(0,t.jsxs)(n.p,{children:["Note that the following backup steps mainly point to actions from an official ",(0,t.jsx)(n.a,{href:"https://goharbor.io/docs/main/administration/backup-restore",children:"Backup And Restore Harbor With Velero"})," tutorial.\nIn this guide, find the added value from additional explanations/hints and up-to-date commands."]}),"\n",(0,t.jsxs)(n.p,{children:["Harbor, by design, consists of multiple (micro)services that could store their data\nvariously, based on the Harbor configuration. See the ",(0,t.jsx)(n.a,{href:"/docs/container/components/container-registry/docs/persistence",children:"Harbor persistence"}),'\ndocs for further information regarding the Harbor persistence layer. The following steps cover\ncases when Harbor persistence is enabled and the "internal" databases (PostgreSQL and Redis)\nare used.']}),"\n",(0,t.jsx)(n.p,{children:'Note that Redis key-value database is not backed up in both cases, i.e. when "internal"\nor "external" Redis instance is used. As a result, the user sessions of logged users\nthat are stored in Redis will be lost. Hence, after the restore, users should log in\nagain. This data loss should be a low impact on your restored Harbor instance.'}),"\n",(0,t.jsx)(n.p,{children:'PostgreSQL database should be backed up as it stores important metadata of Harbor models,\nlike projects, users, roles, etc. The backup and restore of "internal" PostgreSQL instance\nis covered by this guide. The "external" PostgreSQL backup is not supported by the\nofficial tutorial and is out of the scope of this guide as well.'}),"\n",(0,t.jsxs)(n.p,{children:["Also, keep an eye on the official backup and restore ",(0,t.jsx)(n.a,{href:"https://goharbor.io/docs/main/administration/backup-restore/#limitations",children:"limitations"}),"\nsection to be aware of the potential impact on your Harbor instance. The limitation:\n",(0,t.jsx)(n.code,{children:"The upload purging process may cause backup failure"})," mentioned that it is better to\nincrease registry upload purging interval (it is a background process that periodically\nremoves orphaned files from the upload directories of the registry, see the ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/registry/configuration/#uploadpurging",children:"docs"}),").\nThis interval is by ",(0,t.jsx)(n.a,{href:"https://github.com/goharbor/harbor-helm/blob/master/values.yaml#L598",children:"default"}),"\nset to 24h (helm value: ",(0,t.jsx)(n.code,{children:"registry.upload_purging.interval"}),"). If you do not want to change\nthe registry configuration at all you should ensure that the backup will be performed in\nthe middle of two rounds of purging. This background process starts when the registry\ncontainer is initialized, therefore is a good idea to check logs of the registry container\nand determine when is a good time to do a backup, e.g. as follows:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'$ kubectl logs -l component=registry -c registry --tail -1 | grep -i purge\ntime="2023-04-17T09:02:08.320514706Z" level=info msg="Starting upload purge in 24h0m0s" go.version=go1.15.6 instance.id=xxx service=registry version=v2.7.1.m \ntime="2023-04-17T09:09:08.321004645Z" level=info msg="PurgeUploads starting: olderThan=2023-04-10 09:09:08.320738572 +0000 UTC m=-604379.969424455, actuallyDelete=true" \ntime="2023-04-17T09:09:08.331433127Z" level=info msg="Purge uploads finished.  Num deleted=0, num errors=0" \n...\n'})}),"\n",(0,t.jsx)(n.h3,{id:"backup-harbor-instance",children:"Backup Harbor Instance"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.a,{href:"https://goharbor.io/docs/main/administration/backup-restore/#set-harbor-to-readonly",children:["Set Harbor to the ",(0,t.jsx)(n.code,{children:"ReadOnly"})," mode"]})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Backup Harbor:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Using ",(0,t.jsx)(n.code,{children:"snapshot"})," to back up Harbor data:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Exclude the volume of Redis in backup, we need to label the Redis pod, PVC and PV with specific label:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# label the Pod of Redis, replace the namespace and Pod name with yours\n kubectl -n default label pod/harbor-harbor-redis-0 velero.io/exclude-from-backup=true\n # label the PVC of Redis, replace the namespace and PVC name with yours\n kubectl -n default label pvc/data-harbor-harbor-redis-0 velero.io/exclude-from-backup=true\n # get the name of Redis PV, replace the namespace and PVC name with yours\n kubectl -n default get pvc data-harbor-harbor-redis-0 --template={{.spec.volumeName}}\n # label the PV of Redis, replace the pv-name with the one get from last command\n kubectl label pv/pv-name velero.io/exclude-from-backup=true\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Back up Harbor","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# replace the namespace and backup name with yours\nvelero backup create harbor-backup --include-namespaces default --snapshot-volumes --wait\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Using ",(0,t.jsx)(n.code,{children:"Restic"})," to back up Harbor data:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Exclude the volume of Redis in backup","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# replace the namespace and pod name with yours\nkubectl -n default annotate pod/harbor-harbor-redis-0 backup.velero.io/backup-volumes-excludes=data\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Back up Harbor","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"velero backup create harbor-backup --include-namespaces default --default-volumes-to-fs-backup --wait\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.a,{href:"https://goharbor.io/docs/main/administration/backup-restore/#unset-readonly",children:["Unset Harbor from the ",(0,t.jsx)(n.code,{children:"ReadOnly"})," mode"]})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"restore-harbor-instance",children:"Restore Harbor Instance"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://goharbor.io/docs/main/administration/backup-restore/#restore-harbor-instance",children:"Restore Harbor Instance"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>i});var r=s(96540);const t={},a=r.createContext(t);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);