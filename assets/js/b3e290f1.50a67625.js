"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[89031],{87390:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>n,toc:()=>i});const n=JSON.parse('{"id":"container/components/cluster-stacks/components/cluster-stack-operator/topics/using-local-clusterstacks","title":"using-local-clusterstacks","description":"This is a quickstart guide on using the local clusterstacks.","source":"@site/docs/03-container/components/cluster-stacks/components/cluster-stack-operator/topics/using-local-clusterstacks.md","sourceDirName":"03-container/components/cluster-stacks/components/cluster-stack-operator/topics","slug":"/container/components/cluster-stacks/components/cluster-stack-operator/topics/using-local-clusterstacks","permalink":"/docs/container/components/cluster-stacks/components/cluster-stack-operator/topics/using-local-clusterstacks","draft":false,"unlisted":false,"editUrl":"https://github.com/SovereignCloudStack/docs/tree/main/docs/03-container/components/cluster-stacks/components/cluster-stack-operator/topics/using-local-clusterstacks.md","tags":[],"version":"current","frontMatter":{}}');var r=t(74848),o=t(28453);const l={},c=void 0,a={},i=[{value:"Introduction",id:"introduction",level:3},{value:"using right flags",id:"using-right-flags",level:3},{value:"getting release assets",id:"getting-release-assets",level:3},{value:"getting release assets: From Github",id:"getting-release-assets-from-github",level:4},{value:"getting release assets: From csmctl",id:"getting-release-assets-from-csmctl",level:4},{value:"using local mode (toggling local mode)",id:"using-local-mode-toggling-local-mode",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3}];function d(e){const s={a:"a",code:"code",em:"em",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.p,{children:"This is a quickstart guide on using the local clusterstacks."}),"\n",(0,r.jsx)(s.p,{children:"Requirements:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"docker"}),"\n",(0,r.jsx)(s.li,{children:"kind"}),"\n",(0,r.jsx)(s.li,{children:"make"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"introduction",children:"Introduction"}),"\n",(0,r.jsxs)(s.p,{children:["Our controller interacts with cluster-stacks and they are stored inside GitHub releases when used in production. While this is the ideal combination to run our controller it's not a great experience when we want to develop or test new cluster-stacks.\nTo avoid this problem, we introduced ",(0,r.jsx)(s.code,{children:"local_mode"})," and in this mode we start our controller by passing some flags and instead of using remote cluster-stacks, we put them inside a directory locally.\nThis way developers working on developing new cluster-stacks get a more better experience developing cluster-stacks and iterating fast on the same."]}),"\n",(0,r.jsx)(s.h3,{id:"using-right-flags",children:"using right flags"}),"\n",(0,r.jsx)(s.p,{children:"Cluster stacks in local_mode do not fetch release assets directly from GitHub and to work with that we first need to download that and use the correct flags when we start the container.\nThe flags we are using in this repo is following:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"  args:\n    - --leader-elect=true\n    - --release-dir=/tmp\n    - --local=true\n"})}),"\n",(0,r.jsxs)(s.p,{children:["What this means is that, the controller will look for release assets under /tmp directory inside the contanier. If the controller doesn't find release asset under ",(0,r.jsx)(s.code,{children:"/tmp"})," directory then you can get an error in the status of ",(0,r.jsx)(s.code,{children:"clusterstackrelease"})," object."]}),"\n",(0,r.jsx)(s.h3,{id:"getting-release-assets",children:"getting release assets"}),"\n",(0,r.jsx)(s.p,{children:"There are several ways to get release assets. Two common ways:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"From a Github release"}),"\n",(0,r.jsxs)(s.li,{children:["From a directory created by ",(0,r.jsx)(s.a,{href:"https://github.com/SovereignCloudStack/csmctl",children:"csmctl"})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Overall it does not matter who you received the directory."}),"\n",(0,r.jsxs)(s.p,{children:["Tilt expects the release assets under ",(0,r.jsx)(s.code,{children:".release"})," directory of the repository."]}),"\n",(0,r.jsx)(s.h4,{id:"getting-release-assets-from-github",children:"getting release assets: From Github"}),"\n",(0,r.jsx)(s.p,{children:"To download a release asset from Github use the following commands."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"mkdir -p .release/docker-ferrol-1-27-v2\ncd .release/docker-ferrol-1-27-v2\ngh release download -R sovereigncloudstack/cluster-stacks docker-ferrol-1-27-v2\n"})}),"\n",(0,r.jsxs)(s.p,{children:["You can also fetch the release asset manually. Using ",(0,r.jsx)(s.code,{children:"gh"})," makes it a little bit easier to download all the release asset just by invoking one command."]}),"\n",(0,r.jsxs)(s.p,{children:["Your local ",(0,r.jsx)(s.code,{children:".release"})," directory should have the following structure."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"$ tree .release/\n.release/\n\u2514\u2500\u2500 docker-ferrol-1-27-v2\n    \u251c\u2500\u2500 cluster-addon-values.yaml\n    \u251c\u2500\u2500 docker-ferrol-1-27-cluster-addon-v2.tgz\n    \u251c\u2500\u2500 docker-ferrol-1-27-cluster-class-v2.tgz\n    \u251c\u2500\u2500 metadata.yaml\n    \u251c\u2500\u2500 node-images.yaml\n    \u2514\u2500\u2500 topology-docker.yaml\n\n2 directories, 6 files\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"NOTE: This directory structure is very important and you should have the same in order for the controller to work and sync."})}),"\n",(0,r.jsx)(s.h4,{id:"getting-release-assets-from-csmctl",children:"getting release assets: From csmctl"}),"\n",(0,r.jsxs)(s.p,{children:["If you use ",(0,r.jsx)(s.a,{href:"https://github.com/SovereignCloudStack/csmctl",children:"csmctl"}),", then it creates the required directory under ",(0,r.jsx)(s.code,{children:"release"}),"."]}),"\n",(0,r.jsx)(s.p,{children:"Example:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"\u276f csmctl create tests/cluster-stacks/docker/ferrol -m hash\nCreated releases/docker-ferrol-1-27-v0-sha-7ff9188\n"})}),"\n",(0,r.jsx)(s.p,{children:"Copy this directory to .release:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"cp -a releases/docker-ferrol-1-27-v0-sha-7ff9188 ../cluster-stack-operator/.release\n"})}),"\n",(0,r.jsx)(s.h3,{id:"using-local-mode-toggling-local-mode",children:"using local mode (toggling local mode)"}),"\n",(0,r.jsx)(s.p,{children:"From a user perspective who is using tilt to develop and test local cluster-stacks, we just have to make one change in Tiltfile and restart the complete setup all over again."}),"\n",(0,r.jsxs)(s.p,{children:["For making changes in tilt environment, we use ",(0,r.jsx)(s.code,{children:"tilt-settings.yaml"})," file. If you don't have it then please copy it from ",(0,r.jsx)(s.code,{children:"tilt-settings.yaml.example"})," which is at the root of the repo using the following command."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"cp tilt-settings.yaml.example tilt-settings.yaml\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Now, since you have your ",(0,r.jsx)(s.code,{children:"tilt-settings.yaml"})," ready, you have to edit ",(0,r.jsx)(s.code,{children:"local_mode"})," and make it to ",(0,r.jsx)(s.code,{children:"true"}),"\nYour ",(0,r.jsx)(s.code,{children:"tilt-settings.yaml"})," file should look following:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:"allowed_contexts:\n  - kind-cso\nlocal_mode: false\n# truncated\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Once you're toggled ",(0,r.jsx)(s.code,{children:"local_mode"})," to ",(0,r.jsx)(s.code,{children:"true"}),", you're ready to start your tilt setup. Use the following command to start it."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"make tilt-up\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Once the setup is ready and you've the cluster-stack-operator pod running, you can exec into the container and check the ",(0,r.jsx)(s.code,{children:"/tmp"})," directory for the presence of cluster-stacks."]}),"\n",(0,r.jsx)(s.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"$ kubectl -n cso-system exec -it cso-controller-manager-5bdc445647-j4p9p -- sh\n/ # tree /tmp/\n/tmp/\n\u2514\u2500\u2500 cluster-stacks\n    \u2514\u2500\u2500 docker-ferrol-1-27-v2\n        \u251c\u2500\u2500 cluster-addon-values.yaml\n        \u251c\u2500\u2500 docker-ferrol-1-27-cluster-addon-v2.tgz\n        \u251c\u2500\u2500 docker-ferrol-1-27-cluster-class-v2.tgz\n        \u251c\u2500\u2500 metadata.yaml\n        \u251c\u2500\u2500 node-images.yaml\n        \u2514\u2500\u2500 topology-docker.yaml\n\n2 directories, 6 files\n"})}),"\n",(0,r.jsxs)(s.p,{children:["You can now click on ",(0,r.jsx)(s.code,{children:"+"})," button on the right hand side of tilt UI to create a workload cluster. Once the cluster is created you can check the status of the components via the following commands."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:" $ kubectl get clusterstack -A\nNAMESPACE   NAME           PROVIDER   CLUSTERSTACK   K8S    CHANNEL   AUTOSUBSCRIBE   USABLE   LATEST                            AGE     REASON   MESSAGE\ncluster     clusterstack   docker     ferrol         1.27   stable    false           v2       docker-ferrol-1-27-v2 | v1.27.3   5m16s\n\n $ kubectl get clusterstackreleases.clusterstack.x-k8s.io -A\nNAMESPACE   NAME                    K8S VERSION   READY   AGE     REASON   MESSAGE\ncluster     docker-ferrol-1-27-v2   v1.27.3       true    5m16s\n\n $ kubectl get clusters -A\nNAMESPACE   NAME          CLUSTERCLASS            PHASE         AGE     VERSION\ncluster     test-dfkhje   docker-ferrol-1-27-v2   Provisioned   2m46s   v1.27.3\n"})})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,s,t)=>{t.d(s,{R:()=>l,x:()=>c});var n=t(96540);const r={},o=n.createContext(r);function l(e){const s=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),n.createElement(o.Provider,{value:s},e.children)}}}]);